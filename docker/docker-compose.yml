# For rootless podman, use: podman run --userns=keep-id ...
# For docker, volumes will use the container's UID 1000
# See test-compose/ directory for working examples
#
# Password is provided exclusively via a file mounted at /run/secrets/imap_password.
# No environment variable is used for secrets.

services:
  cli:
    image: email-archiver:latest
    build:
      context: ..
    volumes:
      - ${CONFIG_PATH:-./config}:/home/archiver/.config:ro
      - ${DATA_PATH:-./data}:/home/archiver/Mail/imap:rw
      - ${STATE_PATH:-./state}:/home/archiver/.local/state/email-archiver:rw
      - ${PASSWORD_FILE}:/run/secrets/imap_password:ro

  scheduler:
    image: email-archiver:latest
    build:
      context: ..
    entrypoint: ["/usr/local/bin/scheduler"]
    volumes:
      - ${CONFIG_PATH:-./config}:/home/archiver/.config:ro
      - ${DATA_PATH:-./data}:/home/archiver/Mail/imap:rw
      - ${STATE_PATH:-./state}:/home/archiver/.local/state/email-archiver:rw
      - ${PASSWORD_FILE}:/run/secrets/imap_password:ro
    environment:
      SCHEDULE_INTERVAL: ${SCHEDULE_INTERVAL:-3600}
      ARCHIVER_ARGS: ${ARCHIVER_ARGS:-}
    restart: unless-stopped
